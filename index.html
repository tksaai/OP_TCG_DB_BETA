<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- 1. PWAとモバイル対応のためのメタタグ (viewport-fit=cover が重要) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>OP-TCG DB PWA</title>
    <!-- CSSファイル -->
    <link rel="stylesheet" href="style.css">
    
    <!-- 2. Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- 3. iOS対応 -->
    <meta name="apple-mobile-web-app-capable" content="yes"> 
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OP-TCG DB">
    
    <!-- 4. アイコン -->
    <link rel="apple-touch-icon" href="icons/iconx192.png">
    <link rel="icon" href="icons/iconx192.png" sizes="192x192">
    
    <!-- 5. 必要なライブラリ (IndexedDBラッパー) -->
    <!-- defer を削除し、head内でブロッキングロード -->
    <script src="https://cdn.jsdelivr.net/npm/idb@8/build/umd.js"></script>
</head>
<body>

    <!-- アプリケーション全体のラッパー -->
    <div class="app-container">

        <!-- 6. ヘッダー (固定) -->
        <header class="app-header">
            <div class="header-content">
                <div class="search-bar-container">
                    <input type="search" id="search-bar" placeholder="名前, テキスト, カード番号...">
                    <button id="clear-search-btn" class="clear-search-btn" aria-label="検索クリア">&times;</button>
                </div>
                <button id="filter-btn" class="header-btn filter-btn" aria-label="フィルタ">
                    <!-- SVG Filter Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
                    </svg>
                </button>
            </div>
            <!-- 7. キャッシュ進捗バー (通常は非表示) -->
            <div id="cache-progress-container" class="cache-progress-container" style="display: none;">
                <div id="cache-progress-bar" class="cache-progress-bar"></div>
                <span id="cache-progress-text" class="cache-progress-text"></span>
            </div>
        </header>

        <!-- 8. メインコンテンツ (スクロール可能) -->
        <main id="main-content" class="main-content">
            <div id="loading-indicator" class="loading-indicator">
                <div class="spinner"></div>
                <p>データベースを準備中...</p>
            </div>
            <div id="card-list-container" class="card-list-container">
                <!-- カード画像はJavaScriptによってここに挿入されます -->
            </div>
        </main>

        <!-- 9. フッター (固定) -->
        <footer class="app-footer">
            <nav class="footer-nav">
                <button class="nav-btn active" data-tab="cards" aria-label="カード一覧">
                    <!-- SVG Cards Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M20 4H4C2.9 4 2 4.9 2 6v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 18V6h16v12H4z"/>
                    </svg>
                    <span>Cards</span>
                </button>
                <button class="nav-btn" data-tab="decks" aria-label="デッキ構築" disabled>
                    <!-- SVG Decks Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12z"/>
                    </svg>
                    <span>Decks</span>
                </button>

                <!-- 列数切り替えボタン -->
                <button id="column-toggle-btn" class="nav-btn" data-tab="columns" aria-label="列数切り替え">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24" class="column-icon">
                        <!-- 四角い枠 -->
                        <path d="M21 2H3c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 18H5V4h14v16z"/>
                    </svg>
                    <!-- このspanをCSSでSVGの中央に配置する -->
                    <span id="column-count-display" class="column-count-display">3</span>
                </button>

                <button id="settings-btn" class="nav-btn" data-tab="settings" aria-label="設定">
                    <!-- SVG Settings Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.08.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>
                    </svg>
                    <span>Settings</span>
                </button>
            </nav>
        </footer>
    </div>

    <!-- 10. モーダル: フィルタ -->
    <div id="filter-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content-wrapper">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>フィルタ</h2>
                    <button id="close-filter-modal-btn" class="modal-close-btn" aria-label="閉じる">&times;</button>
                </div>
                <div id="filter-options-container" class="modal-body filter-options-container">
                    <!-- フィルタオプションはJavaScriptによってここに挿入されます -->
                </div>
                <div class="modal-footer">
                    <button id="reset-filter-btn" class="modal-btn modal-btn-secondary">リセット</button>
                    <button id="apply-filter-btn" class="modal-btn modal-btn-primary">適用</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 11. モーダル: 設定 -->
    <div id="settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content-wrapper">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>設定</h2>
                    <button id="close-settings-modal-btn" class="modal-close-btn" aria-label="閉じる">&times;</button>
                </div>
                <div class="modal-body">
                    
                    <fieldset class="settings-group">
                        <legend>キャッシュ管理</legend>
                        <div class="setting-item">
                            <p>全カードの画像をローカルに保存し、オフラインでの表示を高速化します。(ストレージを大量に消費する可能性があります)</p>
                            <button id="cache-all-images-btn" class="modal-btn modal-btn-primary">全画像キャッシュ実行</button>
                        </div>
                        <div class="setting-item">
                            <p>データベースと画像キャッシュをすべて削除し、アプリを初期状態に戻します。</p>
                            <button id="clear-all-data-btn" class="modal-btn modal-btn-danger">全データ削除</button>
                        </div>
                    </fieldset>

                    <div class="app-version">
                        <p>App Version: <span id="app-version-info">1.0.0</span></p>
                        <p>Card Data: <span id="card-data-version-info">不明</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 12. モーダル: ライトボックス (画像拡大) -->
    <div id="lightbox-modal" class="lightbox-overlay" style="display: none;">
        <span id="lightbox-close-btn" class="lightbox-close-btn" aria-label="閉じる">&times;</span>
        <img id="lightbox-image" class="lightbox-image" src="" alt="拡大画像">
        <div id="lightbox-fallback" class="lightbox-fallback"></div>
    </div>

    <!-- 13. 通知エリア -->
    <div id="notification-area">
        <!-- DB更新通知 -->
        <div id="db-update-notification" class="notification-toast" style="display: none;">
            <p>カードデータが更新されました。</p>
            <button id="db-update-apply-btn">更新</button>
            <button id="db-update-dismiss-btn" class="dismiss-btn">&times;</button>
        </div>
        <!-- アプリ更新通知 -->
        <div id="app-update-notification" class="notification-toast" style="display: none;">
            <p>アプリが更新されました。</p>
            <button id="app-update-apply-btn">再起動</button>
        </div>
        <!-- 汎用メッセージ通知 -->
        <div id="message-toast" class="notification-toast" style="display: none;">
            <p id="message-toast-text"></p>
            <button id="message-toast-dismiss-btn" class="dismiss-btn">&times;</button>
        </div>
    </div>

    <!-- 14. メインスクリプト (defer を追加) -->
    <script src="app.js" defer></script>

</body>
</html>

